service: toilet-cubicle-system

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-southeast-1
  stage: ${opt:stage}
  memorySize: 2048
  vpc:
    securityGroupIds:
      - sg-7623bc3c
    subnetIds:
      - subnet-64f1963d
      - subnet-92f952f4
      - subnet-d3469e9b
  stackTags:
    ProjectName: ALNG
    Environment: ${self:provider.stage}
  iam:
    role:
      statements:
        - Effect: Allow
          Action: 's3:*'
          Resource:
            - 'arn:aws:s3:::a-low-l-training-data/*'
            - 'arn:aws:s3:::a-low-l-training-data'
            - 'arn:aws:s3:::a-low-l-snapshots/*'
            - 'arn:aws:s3:::a-low-l-snapshots'
        - Effect: Allow
          Action: 'rekognition:*'
          Resource:
            - '*'
        - Effect: Allow
          Action: 'kafka-cluster:*'
          Resource:
            - '*'

            

plugins:
  - serverless-offline
  - serverless-prune-plugin
  - serverless-plugin-resource-tagging

custom:
  prune:
    automatic: true
    includeLayers: true
    number: 3

functions:
  api:
    handler: app.api
    events:
      - http:
          path: sample/{proxy+}
          method: ANY

  train:
    handler: app.train
  
  detect:
    handler: app.detect
    events:
      - s3:
          bucket: a-low-l-snapshots
          event: s3:ObjectCreated:*
          rules:
            - prefix: cam01/
          existing: true
          forceDeploy: true

package:
  individually: true